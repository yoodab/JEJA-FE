name: Frontend Auto Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-front:
    runs-on: self-hosted

    steps:
      # 1. Runner 작업 폴더 청소
      - name: Clean up old files
        run: sudo rm -rf ./*

      # 2. 코드 다운로드
      - name: Checkout source code
        uses: actions/checkout@v3

      # 3. 의존성 설치 및 빌드
      - name: Install & Build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        run: |
          echo "현재 적용된 API 주소: $VITE_API_BASE_URL"
          npm install --legacy-peer-deps
          npm run build

      # 4. 결과물 이동 
      - name: Deploy to Nginx
        run: |
          echo "Nginx가 바라보는 폴더로 배포 시작!"
          
          # Nginx가 실제로 보고 있는 폴더 비우기
          sudo rm -rf /home/dabin/frontend/dist/*
          
          # 폴더가 없을 수도 있으니 생성 (안전장치)
          sudo mkdir -p /home/dabin/frontend/dist/

          # 빌드된 파일(dist)을 Nginx 폴더로 복사
          sudo cp -r dist/* /home/dabin/frontend/dist/
          
          # Nginx 재시작
          sudo systemctl restart nginx
          echo "파일 교체 완료!"

      # 5. Cloudflare 캐시 자동 삭제 
      - name: Purge Cloudflare Cache
        env:
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          echo "Cloudflare 캐시를 삭제합니다..."
          curl -X POST "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/purge_cache" \
          -H "Authorization: Bearer $CF_API_TOKEN" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}'
          echo "캐시 삭제 요청 완료!"
