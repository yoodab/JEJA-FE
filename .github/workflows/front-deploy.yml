name: Frontend Auto Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-front:
    runs-on: self-hosted

    steps:
      # 1. Runner 작업 폴더 청소
      - name: Clean up old files
        run: sudo rm -rf ./*

      # 2. 코드 다운로드
      - name: Checkout source code
        uses: actions/checkout@v3

      # 3. .env 파일 생성 (폴더 이동 없이 바로 생성)
      - name: Create .env file
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" > .env

      # 4. 의존성 설치 및 빌드 (폴더 이동 없이 바로 실행)
      - name: Install & Build
        run: |
          # 버전 호환성 무시하고 강제 설치 옵션 추가
          npm install --legacy-peer-deps
          npm run build

      # 5. 결과물 이동 (경로 수정됨: frontend/dist -> dist)
      - name: Deploy to Nginx
        run: |
          # dist 폴더 내용을 웹서버로 복사
          sudo rm -rf /var/www/html/*
          sudo cp -r dist/* /var/www/html/
          
          # Nginx 재시작
          sudo systemctl restart nginx
          echo "배포 끝!"